"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createPostsRouter = void 0;
const express_1 = require("express");
const auth_middleware_1 = require("@/middleware/auth.middleware");
const upload_middleware_1 = require("@/middleware/upload.middleware");
const socia_media_publisher_factory_1 = require("@/modules/social/factories/socia-media-publisher.factory");
const account_repository_1 = require("@/modules/social/repositories/account.repository");
const social_media_post_sender_service_1 = require("@/modules/social/services/social-media-post-sender.service");
const async_handler_1 = require("@/shared/http/async-handler");
const http_client_1 = require("@/shared/http-client");
const queue_1 = require("@/shared/queue");
const social_media_errors_1 = require("@/shared/social-media-errors");
const video_processor_1 = require("@/shared/video-processor/video-processor");
const media_uploader_1 = require("@/shared/media-uploader/media-uploader");
const posts_controller_1 = require("../controllers/posts.controller");
const posts_repository_1 = require("../repositories/posts.repository");
const posts_service_1 = require("../services/posts.service");
const mediaFields = [...Array.from({ length: 10 }, (_, i) => ({ name: `media[${i}]` })), { name: 'coverImage' }];
const createPostsRouter = (logger, db) => {
    const router = (0, express_1.Router)();
    const postsRepository = new posts_repository_1.PostsRepository(db, logger);
    const accountRepository = new account_repository_1.AccountRepository(db, logger);
    const mediaUploader = new media_uploader_1.S3Uploader(logger);
    const apiClient = new http_client_1.AxiosHttpClient();
    const socialMediaErrorHandler = new social_media_errors_1.SocialMediaErrorHandler(logger);
    const videoProcessor = new video_processor_1.VideoProcessor(logger);
    const socialMediaPublisherFactory = new socia_media_publisher_factory_1.SocialMediaPublisherFactory(logger, accountRepository, postsRepository, apiClient, socialMediaErrorHandler, videoProcessor, mediaUploader);
    const socialMediaPostSender = new social_media_post_sender_service_1.SocialMediaPostSenderService(postsRepository, logger, socialMediaErrorHandler, socialMediaPublisherFactory);
    const postScheduler = new queue_1.BullMqPostScheduler();
    const postsService = new posts_service_1.PostsService(postsRepository, mediaUploader, logger, socialMediaPostSender, socialMediaErrorHandler, postScheduler);
    const postsController = new posts_controller_1.PostsController(postsService, logger);
    router.use(auth_middleware_1.authMiddleware);
    router.post('/post', upload_middleware_1.upload.fields(mediaFields), (0, async_handler_1.asyncHandler)(postsController.createPost.bind(postsController)));
    router.post('/post/retry', (0, async_handler_1.asyncHandler)(postsController.retryPostTarget.bind(postsController)));
    router.post('/post/target/delete', (0, async_handler_1.asyncHandler)(postsController.deletePostTarget.bind(postsController)));
    router.put('/post/:postId', upload_middleware_1.upload.single('media'), (0, async_handler_1.asyncHandler)(postsController.editPost.bind(postsController)));
    router.delete('/post/:postId', (0, async_handler_1.asyncHandler)(postsController.deletePost.bind(postsController)));
    router.get('/posts', (0, async_handler_1.asyncHandler)(postsController.getPostsByFilters.bind(postsController)));
    router.get('/posts/by-date', (0, async_handler_1.asyncHandler)(postsController.getPostsByDate.bind(postsController)));
    router.get('/posts/failed/count', (0, async_handler_1.asyncHandler)(postsController.getPostsFailedCount.bind(postsController)));
    router.get('/posts/failed', (0, async_handler_1.asyncHandler)(postsController.getFailedPostTargets.bind(postsController)));
    router.get('/posts/rate-limits', (0, async_handler_1.asyncHandler)(postsController.getRateLimits.bind(postsController)));
    return router;
};
exports.createPostsRouter = createPostsRouter;
