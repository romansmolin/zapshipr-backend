# Медиа-обработка

## Загрузка медиа

### S3Uploader

Все медиа-файлы загружаются в AWS S3 через `S3Uploader` (`src/shared/media-uploader/`).

**Особенности**:
- Поддержка изображений и видео
- Автоматическая обработка перед загрузкой
- Генерация уникальных имен файлов
- Возврат публичных URL для доступа

### Multer Middleware

Загрузка файлов на сервер происходит через `multer`:
- Middleware: `src/middleware/upload.middleware.ts`
- Поддержка множественных файлов
- Ограничения по размеру и типу файлов

## Обработка медиа

### Изображения

**Инструмент**: Sharp (`src/shared/image-processor/`)

**Операции**:
- Ресайз до оптимальных размеров
- Оптимизация качества
- Конвертация форматов
- Создание превью

**Поддерживаемые форматы**: JPEG, PNG, WebP

### Видео

**Инструмент**: fluent-ffmpeg (`src/shared/video-processor/`)

**Операции**:
- Конвертация в совместимые форматы
- Изменение разрешения
- Сжатие для оптимизации размера
- Извлечение превью кадров

**Временные файлы**: 
- `temp/video-processor/` — обработка видео
- `temp/video-converter/` — конвертация

## Проверка совместимости

Перед публикацией система проверяет совместимость медиа с выбранными платформами:

- **Форматы**: Каждая платформа поддерживает определенные форматы
- **Размеры**: Ограничения по размеру файлов
- **Разрешения**: Минимальные/максимальные размеры изображений и видео
- **Длительность**: Для видео (особенно TikTok, Instagram Reels)

При несовместимости возвращается ошибка с деталями:
```typescript
{
  ok: false,
  kind: 'MEDIA_COMPATIBILITY',
  incompatibleAccounts: [
    {
      accountId: '...',
      platform: 'TikTok',
      reason: 'Video too long (max 60s)'
    }
  ]
}
```

## Работа с медиа в постах

1. **Загрузка**: Файлы загружаются через multer
2. **Обработка**: Изображения/видео обрабатываются
3. **Проверка**: Проверка совместимости с платформами
4. **Загрузка в S3**: Обработанные файлы загружаются
5. **Связь с постом**: Создаются записи в `mediaAssets` и `postMediaAssets`
6. **Публикация**: Медиа отправляются на платформы вместе с постом

