# Важные замечания и лучшие практики

## Основные принципы

### 1. Всегда используйте интерфейсы

Интерфейсы упрощают тестирование и замену реализаций:
- Создавайте интерфейсы для всех сервисов и репозиториев
- Используйте dependency injection через конструкторы
- Это позволяет легко создавать моки для тестов

### 2. Логируйте ошибки

Передавайте logger во все сервисы и репозитории:
- Логируйте все ошибки с контекстом
- Используйте структурированное логирование
- Включайте информацию о запросе (method, URL, userId)

### 3. Валидируйте входные данные

Всегда используйте Zod схемы для валидации:
- Валидируйте на уровне роутов
- Не доверяйте данным от клиента
- Возвращайте понятные сообщения об ошибках

### 4. Обрабатывайте ошибки централизованно

Используйте централизованный error handler:
- Всегда используйте `asyncHandler` для async роутов
- Бросайте `AppError` или `BaseAppError` для бизнес-ошибок
- Не обрабатывайте ошибки в контроллерах вручную

### 5. Типизируйте всё

Избегайте использования `any`:
- TypeScript настроен в strict режиме
- Используйте правильные типы для всех переменных
- Используйте `type` для типов данных, `interface` для контрактов

### 6. Следуйте структуре модулей

Не смешивайте логику разных модулей:
- Каждый модуль должен быть самодостаточным
- Используйте shared для общих утилит
- Избегайте циклических зависимостей

### 7. Используйте asyncHandler

Для всех async роутов:
```typescript
router.post('/posts', asyncHandler(controller.create.bind(controller)))
```

Это гарантирует, что ошибки будут обработаны централизованным handler'ом.

### 8. Фабрики для платформ

Не создавайте коннекторы/паблишеры напрямую:
- Используйте `SocialMediaConnectorFactory`
- Используйте `SocialMediaPublisherFactory`
- Это обеспечивает единообразие и упрощает тестирование

## Работа с медиа

### Загрузка
- Все медиа загружаются через `multer` middleware
- Обработка происходит перед загрузкой в S3
- Проверяйте размер и тип файлов на уровне middleware

### Обработка
- Видео конвертируются в совместимые форматы
- Изображения оптимизируются через Sharp
- Очищайте временные файлы после обработки

### Совместимость
- Всегда проверяйте совместимость медиа с платформами перед публикацией
- Возвращайте понятные ошибки с деталями несовместимости
- Учитывайте ограничения каждой платформы

## Работа с базой данных

### Схемы
- Определяйте схемы в `entity/*.schema.ts`
- Экспортируйте через централизованный `schema.ts`
- Используйте типизированный клиент Drizzle

### Запросы
- Используйте типизированные запросы Drizzle
- Избегайте raw SQL, если возможно
- Используйте транзакции для связанных операций

### Миграции
- Создавайте миграции для всех изменений схемы
- Тестируйте миграции на dev окружении
- Не изменяйте существующие миграции

## Безопасность

### Аутентификация
- Всегда проверяйте токены через middleware
- Используйте HTTP-only cookies для токенов
- Регулярно обновляйте refresh tokens

### Данные
- Хешируйте пароли через bcrypt
- Шифруйте чувствительные данные (токены доступа)
- Не логируйте чувствительную информацию

### Валидация
- Валидируйте все входные данные
- Санитизируйте данные перед сохранением
- Используйте параметризованные запросы (Drizzle делает это автоматически)

## Производительность

### Очереди
- Используйте очереди для долгих операций
- Не блокируйте API запросы тяжелыми задачами
- Настройте правильные приоритеты задач

### Медиа
- Обрабатывайте медиа асинхронно
- Используйте оптимизацию изображений
- Кэшируйте результаты обработки, если возможно

### База данных
- Используйте индексы для часто запрашиваемых полей
- Избегайте N+1 запросов
- Используйте пагинацию для больших списков

## Тестирование

### Структура
- Структура проекта поддерживает unit-тестирование через интерфейсы
- Используйте dependency injection для моков
- Тестируйте бизнес-логику в сервисах, не в контроллерах

### Моки
- Мокайте репозитории и внешние сервисы
- Используйте интерфейсы для создания моков
- Тестируйте изолированно каждый компонент

## Документация

### Код
- Пишите понятные имена переменных и функций
- Добавляйте комментарии для сложной логики
- Документируйте публичные API через JSDoc

### Изменения
- Обновляйте документацию при изменении API
- Документируйте breaking changes
- Ведите changelog для важных изменений

